"use strict";angular.module("profileviewerApp",["ngCookies","ngResource","ngRoute","ui.bootstrap","ngClipboard","monospaced.qrcode"]).config(["$compileProvider","$locationProvider","$routeProvider",function(a,b,c){a.aHrefSanitizationWhitelist(/^\s*(https?|file|tel|skype|mailto|callto|bitmsg|xmpp|bitcoin|namecoin|litecoin|dogecoin):/),b.html5Mode(!0).hashPrefix("!"),c.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).when("/about",{templateUrl:"views/about.html",controller:"AboutCtrl"}).when("/:username",{templateUrl:"views/profile.html",controller:"ProfileCtrl"}).otherwise({redirectTo:"/"})}]),angular.module("profileviewerApp").factory("Utils",[function(){var a={};return a.hasProp=function(a){for(var b=[].slice.call(arguments,1);a&&b.length;)a=a[b.shift()];return b.length?null:a},a.getProp=function(a){for(var b=[].slice.call(arguments,1);a&&b.length;)a=a[b.shift()];return b.length?null:a},a.loadAvatar=function(a,b,c){var d=new Image;d.onload=function(){var a=document.getElementById(b);if(a.appendChild(d),d.height<d.width){d.style.height="100%",d.style.width="auto";var e=-(c/d.height*d.width-c)/2;d.style.marginLeft=e.toString()+"px"}},d.src=a},a.loadBackground=function(a,b){var c=new Image;c.onload=function(){var a=document.getElementById(b);a.style.backgroundImage="url("+c.src+")",a.style.backgroundSize="cover",a.style.webkitBackgroundSize="cover",a.style.mozBackgroundSize="cover"},c.src=a},a}]),angular.module("profileviewerApp").factory("Person",["$http","Utils",function(a,b){var c={},d=b.hasProp;return c.findByUsername=function(b,c,e){var f="http://onenameapi.herokuapp.com/users/"+b;a({method:"GET",url:f}).success(function(b){var e=null;d(b,"graph","url")?e=b.graph.url:d(b,"network","url")&&(e=b.network.url),e?a({method:"GET",url:e}).success(function(a){b.graph=a,c(b)}).error(function(a){console.log(a)}):(b.graph={},c(b))}).error(function(a){e(a)})},c.search=function(b,c,d){if(!b)return void c({results:[]});var e="http://onenameapi.herokuapp.com/search?query="+b;a({method:"GET",url:e}).success(function(a){c(a)}).error(function(a){d(a)})},c}]),angular.module("profileviewerApp").factory("PGPKey",["$http",function(a){var b={};return b.get=function(b,c,d){a({method:"GET",url:"https://onename.io/api/pgpkey?url="+escape(b)}).success(c).error(d)},b}]),angular.module("profileviewerApp").directive("typeahead",["$timeout",function(a){return{restrict:"E",transclude:!0,replace:!0,templateUrl:"views/_searchbar.html",scope:{search:"&",select:"&",items:"=",term:"=",timeout:"@",placeholder:"@"},controller:["$scope",function(a){a.items=[],a.hide=!1,this.activate=function(b){a.active=b},this.activateNextItem=function(){var b=a.items.indexOf(a.active);this.activate(a.items[(b+1)%a.items.length])},this.activatePreviousItem=function(){var b=a.items.indexOf(a.active);this.activate(a.items[0===b?a.items.length-1:b-1])},this.isActive=function(b){return a.active===b},this.selectActive=function(){this.select(a.active)},this.select=function(){},a.isVisible=function(){return!a.hide&&(a.focused||a.mousedOver)}}],link:function(b,c,d,e){var f=c.find("form"),g=f.find("input"),h=c.find("> div");g.bind("focus",function(){b.$apply(function(){b.focused=!0,b.query()})}),g.bind("blur",function(){b.$apply(function(){b.focused=!1})}),h.bind("mouseover",function(){b.$apply(function(){b.mousedOver=!0})}),h.bind("mouseleave",function(){b.$apply(function(){b.mousedOver=!1})}),g.bind("keyup",function(a){(9===a.keyCode||13===a.keyCode)&&(console.log("tab/enter!"),b.$apply(function(){e.selectActive()})),27===a.keyCode&&b.$apply(function(){b.hide=!0})}),g.bind("keydown",function(a){(9===a.keyCode||13===a.keyCode||27===a.keyCode)&&a.preventDefault(),40===a.keyCode&&(console.log("down arrow!"),a.preventDefault(),b.$apply(function(){e.activateNextItem()})),38===a.keyCode&&(console.log("up arrow!"),a.preventDefault(),b.$apply(function(){e.activatePreviousItem()}))}),b.$watch("items",function(a){e.activate(a.length?a[0]:null)}),b.$watch("isVisible()",function(a){a?g&&g.length>0&&h.css({top:g.position().top+g[0].offsetHeight,left:g.position().left,position:"absolute",display:"block",width:g[0].offsetWidth}):h.css("display","none")}),b.timeout=parseInt(b.timeout),b.query=function(){b.pendingPromise&&a.cancel(b.pendingPromise),b.pendingPromise=a(function(){b.hide=!1,b.search({term:b.term})},b.timeout)}}}}]).directive("typeaheadItem",function(){return{require:"^typeahead",link:function(a,b,c,d){var e=a.$eval(c.typeaheadItem);a.$watch(function(){return d.isActive(e)},function(a){a?b.addClass("active"):b.removeClass("active")}),b.bind("mouseenter",function(){a.$apply(function(){d.activate(e)})}),b.bind("click",function(){a.$apply(function(){d.select(e)})})}}}),angular.module("profileviewerApp").filter("capitalize",function(){return function(a){return a?a.replace(/([^\W_]+[^\s-]*) */g,function(a){return a.charAt(0).toUpperCase()+a.substr(1).toLowerCase()}):""}}).filter("formatFacebookUsername",function(){return function(a){return a&&(a=a.replace(/http.*facebook.com\//,"").replace(/^facebook.com\//,"")),a.toLowerCase().match(/^[a-z\d.]{5,}$/i)?a:null}}).filter("formatGithubUsername",function(){return function(a){return a&&(a=a.replace(/http.*github.com\//,"").replace(/^github.com\//,"")),a.toLowerCase().match(/^[0-9a-z_-]+$/)?a:null}}).filter("formatTwitterUsername",function(){return function(a){return a&&(a=a.replace(/^@/,"").replace(/http.*twitter.com\//,"").replace(/^twitter.com\//,"")),a.toLowerCase().match(/^[0-9a-z_]+$/)?a:null}}).filter("formatDomain",function(){function a(a){var b=document.createElement("a");return b.href=a,b.hostname}return function(b){if(b){var c=a(b);return c.replace("www.","")}return null}}).filter("pgpFingerprintChunks",function(){function a(a,b,c){return c.replace(new RegExp(a,"g"),b)}return function(b,c){return b?(b=a(" ","",b),b.length>c&&(b=b.substr(b.length-c)),b.match(/.{1,4}/g)):void 0}}),angular.module("profileviewerApp").controller("MainCtrl",["$scope","Person","Utils",function(a,b,c){a.featuredUsers=[{username:"gavin",avatarUrl:"https://s3.amazonaws.com/kd4/gavin"},{username:"jespow",avatarUrl:"https://s3.amazonaws.com/kd4/jespow"},{username:"albertwenger",avatarUrl:"https://pbs.twimg.com/profile_images/1773890030/aew_artistic_bigger.gif"},{username:"andreacastillo",avatarUrl:"https://pbs.twimg.com/profile_images/415589178836262913/1eHaxr0j.jpeg"},{username:"peter",avatarUrl:"https://s3.amazonaws.com/kd4/peter"},{username:"arianna",avatarUrl:"https://s3.amazonaws.com/97p/ariannas-profile.jpg"},{username:"will",avatarUrl:"https://s3.amazonaws.com/kd4/will"},{username:"fredwilson",avatarUrl:"https://s3.amazonaws.com/65m/fredwilson-avatar.jpg"},{username:"vitalik",avatarUrl:"https://s3.amazonaws.com/kd4/vitalik"},{username:"mattcutts",avatarUrl:"https://s3.amazonaws.com/kd4/mattcutts"},{username:"davidlee",avatarUrl:"https://pbs.twimg.com/profile_images/424215824052658176/eAyEH66A.png"},{username:"naval",avatarUrl:"https://pbs.twimg.com/profile_images/3696617328/667874c5936764d93d56ccc76a2bcc13.jpeg"},{username:"barrysilbert",avatarUrl:"https://pbs.twimg.com/profile_images/2597394462/32b6p3stu0g09zwy8rq5.jpeg"},{username:"justin",avatarUrl:"https://pbs.twimg.com/profile_images/1776226133/image1327350134.png"},{username:"jhuber",avatarUrl:"https://s3.amazonaws.com/kd4/jhuber"},{username:"inesmilans",avatarUrl:"https://pbs.twimg.com/profile_images/442405100938485760/5Pt5F2WA.jpeg"},{username:"cameron",avatarUrl:"https://s3.amazonaws.com/kd4/cwinklevoss"},{username:"tyler",avatarUrl:"https://s3.amazonaws.com/kd4/tyler"}];for(var d=0;d<a.featuredUsers.length;d++)c.loadAvatar(a.featuredUsers[d].avatarUrl,"friend-avatar-"+d,100)}]),angular.module("profileviewerApp").controller("AboutCtrl",function(){}),angular.module("profileviewerApp").controller("ProfileCtrl",["$scope","$routeParams","Utils","Person","$modal",function(a,b,c,d,e){a.user={},a.avatarSize=200,a.friendAvatarSize=100,a.validContactTypes=["email","phone","skype","bitmessage","xmpp"];var f=c.hasProp,g=c.getProp;a.urlDomain=function(a){var b=a.match(/^https?\:\/\/([^\/?#]+)(?:[\/?#]|$)/i),c=b&&b[1];return c},a.processV01Profile=function(c){var d=[],e=[],f=[];if(c.website){var g={url:c.website,iconClass:"fa-link",type:"website dark-gradient",domain:a.urlDomain(c.website)};f.push(g)}if(c.bitcoin){var h={type:"bitcoin",identifier:c.bitcoin};e.push(h)}return{username:b.username,name:c.name,avatarUrl:c.avatar,backgroundUrl:c.cover,location:c.location,bio:c.bio,profiles:d,websites:f,payments:e}},a.processGraphfile=function(a){var b=[],c=[],d=4,e=null;if(a.followees){var h=a.followees;e=Object.keys(h).length;for(var i in Object.keys(h)){var j=Object.keys(h)[i],k=h[j];f(k,"avatar_url")&&(k.avatarUrl=g(k,"avatar_url")),b.push(k),d>i&&(c.push(k),e-=1)}}return{followees:b,featuredFollowees:c,numUnfeatured:e}},a.processV02Profile=function(c){var d=[],e=[],g=[],h=[],i=[],j=null,k=null,l=null,m=[],n=[],o=0,p=null,q=null;if(f(c,"twitter","username")&&f(c,"twitter","proof","url")&&(j={type:"twitter",iconClass:"fa-twitter",username:c.twitter.username,url:"https://twitter.com/"+c.twitter.username,proofUrl:c.twitter.proof.url},d.push(j)),f(c,"facebook","username")&&f(c,"facebook","proof","url")&&(j={type:"facebook",iconClass:"fa-facebook",username:c.facebook.username,url:"https://facebook.com/"+c.facebook.username,proofUrl:c.facebook.proof.url},d.push(j)),f(c,"github","username")&&f(c,"github","proof","url")&&(j={type:"github",iconClass:"fa-github",username:c.github.username,url:"https://github.com/"+c.github.username,proofUrl:c.github.proof.url},d.push(j)),f(c,"bitcoin","address")?e.push({type:"bitcoin",identifier:c.bitcoin.address}):f(c,"bitcoin")&&e.push({type:"bitcoin",identifier:c.bitcoin}),c.graph){var r=a.processGraphfile(c.graph);m=r.followees,g=r.featuredFollowees,o=r.numUnfeatured}if(f(c,"pgp","fingerprint")){var s={type:"pgp",fingerprint:c.pgp.fingerprint};f(c,"pgp","url")&&(s.url=c.pgp.url),i.push(s)}if(f(c,"avatar","url")?k=c.avatar.url:c.avatar&&(k=c.avatar),f(c,"cover","url")?l=c.cover.url:f(c,"cover")&&(l=c.cover),f(c,"name","formatted")?p=c.name.formatted:f(c,"name")&&(p=c.name),f(c,"location","formatted")?q=c.location.formatted:f(c,"location")&&-1!==c.location.toString().indexOf("{")&&(q=c.location),f(c,"contactMethods")&&(n=c.contactMethods),f(c,"email")){var t={type:"email",identifier:c.email};n.append(t)}return{username:b.username,name:p,avatarUrl:k,backgroundUrl:l,location:q,bio:c.bio,followees:m,featuredFriends:g,unfeaturedFriendCount:o,profiles:d,websites:h,payments:e,keychain:i,contactMethods:n}},a.iconClasses={twitter:"fa-twitter",facebook:"fa-facebook",github:"fa-github",linkedin:"fa-linkedin",instagram:"fa-instagram",reddit:"fa-reddit",hackernews:"fa-hacker-news",stackoverflow:"fa-stack-overflow",angellist:"fa-angellist",googleplus:"fa-google-plus"},a.processV03Profile=function(c){var d=[],e=0,g=null,h=null,i=[],j=0,k=null,l=null;f(c,"name","formatted")&&(k=c.name.formatted),f(c,"location","formatted")&&(l=c.location.formatted);for(e in c.photos){var m=c.photos[e];"avatar"===m.type&&m.url&&(g=m.url),"background"===m.type&&m.url&&(h=m.url)}for(e in c.profiles){var n=c.profiles[e];a.iconClasses[n.type]&&(n.iconClass=a.iconClasses[n.type])}if(f(c,"network","followees")&&(d=c.network.followees.slice(0,4)),c.graph){var o=a.processGraphfile(c.graph);i=o.followees,d=o.featuredFollowees,j=o.numUnfeatured}for(e in c.websites){var p=c.websites[e];p.domain=a.urlDomain(p.url)}return{username:b.username,name:k,avatarUrl:g,backgroundUrl:h,location:l,bio:c.bio,followees:i,featuredFriends:d,unfeaturedFriendCount:j,profiles:c.profiles,websites:c.websites,payments:c.payments,keychain:c.keychain,contactMethods:c.contact}},a.processProfile=function(b){var c=null;return b.v?"0.3"===b.v?c=a.processV03Profile(b):"0.2"===b.v?c=a.processV02Profile(b):"0.1"===b.v&&(c=a.processV01Profile(b)):c=a.processV02Profile(b),c},d.findByUsername(b.username,function(b){a.user=a.processProfile(b),c.loadAvatar(a.user.avatarUrl,"user-avatar-container",a.avatarSize),c.loadBackground(a.user.backgroundUrl,"profile-bottom");for(var d=0;d<a.user.featuredFriends.length;d++)c.loadAvatar(a.user.featuredFriends[d].avatarUrl,"friend-avatar-"+d,a.friendAvatarSize)},function(){}),a.openPaymentModal=function(b){var c=e.open({templateUrl:"/views/_sendMoneyModal.html",controller:"SendMoneyCtrl",size:b,resolve:{payments:function(){var b=[],c=["bitcoin","dogecoin","litecoin","namecoin"];for(var d in a.user.payments){var e=a.user.payments[d];e.type&&e.identifier&&-1!==c.indexOf(e.type)&&b.push(e)}return b}}});return c},a.openPublicKeyModal=function(b){var c=e.open({templateUrl:"/views/_publicKeyModal.html",controller:"PublicKeyCtrl",resolve:{publicKey:function(){var c=["pgp","otr","ssh"],d=a.user.keychain[b];return-1===c.indexOf(d.type)?null:d}}});return c},a.openFollowModal=function(){var a=e.open({templateUrl:"/views/_followModal.html",controller:"FollowModalCtrl"});return a},a.openFollowingModal=function(b){var c=e.open({templateUrl:"/views/_followingModal.html",controller:"FollowingModalCtrl",size:b,resolve:{followees:function(){return a.user.followees}}});return c},a.openContactModal=function(b){var c=e.open({templateUrl:"/views/_contactModal.html",controller:"ContactModalCtrl",resolve:{contactMethods:function(){return a.user.contactMethods},index:function(){return b}}});return c}}]),angular.module("profileviewerApp").controller("NavbarCtrl",["$scope","Person","Utils","$modal",function(a,b,c,d){var e=c.hasProp;a.search=function(c){b.search(c,function(b){var c=[];if(b.results){var d=[],f=[],g=[],h=[],i=[];b.results.map(function(b){var c=!1,j=!1,k=0;(e(b,"profile","twitter","username")||e(b,"profile","github","username")||e(b,"profile","facebook","username"))&&(c=!0),a.website&&(c=!0),e(b,"profile","twitter","proof","url")&&(k+=1),e(b,"profile","github","proof","url")&&(k+=1),e(b,"profile","facebook","proof","url")&&(k+=1),e(b,"profile","name","formatted")&&(j=!0),b.username&&(k>2?d.push(b):2===k?f.push(b):1===k?g.push(b):c&&j?h.push(b):i.push(b))}),c=d.concat(f,g,h,i)}a.people=c},function(a){console.log(a)})},a.openSignupModal=function(){var a=d.open({templateUrl:"/views/_signupModal.html",controller:"SignupModalCtrl"});return a}}]),angular.module("profileviewerApp").controller("SendMoneyCtrl",["$scope","$modalInstance","payments",function(a,b,c){a.payments=c,a.selectMethod=function(b){a.index=b,a.address=c[b].identifier,a.paymentType=c[b].type,a.copyButtonText="Click to Copy"},a.selectMethod(0),a.toggleQrcode=function(){a.qrcodeShown=a.qrcodeShown?!1:!0},a.resetAddress=function(){a.address=c[a.index].identifier},a.getTextToCopy=function(){return a.address},a.notifyUserOfCopy=function(){a.copyButtonText="Copied!"},a.ok=function(){b.close()},a.cancel=function(){b.dismiss("cancel")}}]),angular.module("profileviewerApp").controller("PublicKeyCtrl",["$scope","$modalInstance","publicKey","PGPKey",function(a,b,c,d){a.publicKey=c,a.publicKey.url&&d.get(c.url,function(b){a.publicKey.value=b}),a.cancel=function(){b.dismiss("cancel")}}]),angular.module("profileviewerApp").controller("SignupModalCtrl",["$scope","$modalInstance",function(a,b){a.sites=[{name:"onename",url:"https://onename.io"},{name:"namecoin",url:"http://namecoin.info/?p=download"}],a.cancel=function(){b.dismiss("cancel")}}]),angular.module("profileviewerApp").controller("FollowModalCtrl",["$scope","$modal","$modalInstance",function(a,b,c){a.openSignupModal=function(){c.dismiss("cancel");var a=b.open({templateUrl:"/views/_signupModal.html",controller:"SignupModalCtrl"});return a},a.cancel=function(){c.dismiss("cancel")}}]),angular.module("profileviewerApp").controller("FollowingModalCtrl",["$scope","$modalInstance","followees","Utils",function(a,b,c,d){a.followees=c;for(var e=0;e<c.length;e++)d.loadAvatar(c[e].avatarUrl,"followees-avatar-"+e,100);a.cancel=function(){b.dismiss("cancel")}}]),angular.module("profileviewerApp").controller("ContactModalCtrl",["$scope","$modal","$modalInstance","contactMethods","index","$location",function(a,b,c,d,e,f){a.contactMethods=d,a.codes={},a.selectMethod=function(b){a.index=b,a.copyButtonText="Click to Copy",a.contactMethods[a.index].identifier&&(a.identifier=a.contactMethods[a.index].identifier)};var g=f.search();if("code"in g){var h=g.code.split("-").join(" ");a.attemptDecryption(h),a.selectMethod(e)}else a.selectMethod(e);a.attemptDecryption=function(b){for(var c in d){var e=d[c];if(e.encryptedIdentifier)try{var f=sjcl.decrypt(b,e.encryptedIdentifier);e.identifier=f,a.identifier=f}catch(g){a.decryptionAttempted=!0}}},a.resetIdentifier=function(){a.identifier=d[a.index].identifier},a.getTextToCopy=function(){return a.identifier},a.notifyUserOfCopy=function(){a.copyButtonText="Copied!"},a.cancel=function(){c.dismiss("cancel")},a.decryptIdentifier=function(){a.attemptDecryption(a.codes.passphrase)}}]);